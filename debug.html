<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è°ƒè¯•é¡µé¢ - é…ç½®çŠ¶æ€æ£€æŸ¥</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f7;
        }
        .debug-card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            margin: 20px 0;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        .status {
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 500;
            margin: 10px 0;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .warning { background: #fff3cd; color: #856404; }
        .info { background: #d1ecf1; color: #0c5460; }
        button {
            background: #007aff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            margin: 10px 5px;
            font-size: 16px;
        }
        button:hover { background: #0056b3; }
        pre {
            background: #f8f9fa;
            padding: 16px;
            border-radius: 8px;
            overflow-x: auto;
            border: 1px solid #e9ecef;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
        }
    </style>
</head>
<body>
    <h1>ğŸ” é…ç½®è°ƒè¯•é¡µé¢</h1>
    
    <div class="debug-card">
        <h2>ğŸ“‹ é…ç½®çŠ¶æ€æ£€æŸ¥</h2>
        <div id="config-status"></div>
        <button onclick="checkConfig()">ğŸ”„ é‡æ–°æ£€æŸ¥é…ç½®</button>
        <button onclick="clearCache()">ğŸ—‘ï¸ æ¸…é™¤æµè§ˆå™¨ç¼“å­˜</button>
    </div>

    <div class="debug-card">
        <h2>ğŸ”‘ APIå¯†é’¥çŠ¶æ€</h2>
        <div id="api-status"></div>
        <button onclick="testApiKey()">ğŸ§ª æµ‹è¯•APIå¯†é’¥</button>
    </div>

    <div class="debug-card">
        <h2>ğŸ“ è¯¦ç»†é…ç½®ä¿¡æ¯</h2>
        <pre id="config-details"></pre>
    </div>

    <div class="debug-card">
        <h2>ğŸ§ª åŠŸèƒ½æµ‹è¯•</h2>
        <div class="test-section">
            <h3>èŠå¤©ç®¡ç†å™¨æµ‹è¯•</h3>
            <button onclick="testChatManager()">æµ‹è¯•èŠå¤©ç®¡ç†å™¨åˆå§‹åŒ–</button>
            <div id="chat-test-result"></div>
        </div>
    </div>

    <script src="config.js"></script>
    <script>
        // é…ç½®çŠ¶æ€æ£€æŸ¥
        function checkConfig() {
            const statusDiv = document.getElementById('config-status');
            const detailsDiv = document.getElementById('config-details');
            
            let status = '';
            let details = '';
            
            // æ£€æŸ¥é…ç½®æ–‡ä»¶æ˜¯å¦åŠ è½½
            if (window.CONFIG) {
                status += '<div class="status success">âœ… é…ç½®æ–‡ä»¶å·²åŠ è½½</div>';
                details += 'window.CONFIG å­˜åœ¨\n';
                
                if (window.CONFIG.deepseek) {
                    status += '<div class="status success">âœ… DeepSeeké…ç½®å·²åŠ è½½</div>';
                    details += 'DeepSeeké…ç½®: ' + JSON.stringify(window.CONFIG.deepseek, null, 2) + '\n';
                } else {
                    status += '<div class="status error">âŒ DeepSeeké…ç½®æœªæ‰¾åˆ°</div>';
                }
                
                if (window.CONFIG.deepseek && window.CONFIG.deepseek.apiKey) {
                    const key = window.CONFIG.deepseek.apiKey;
                    if (key.startsWith('sk-') && key.length > 20) {
                        status += '<div class="status success">âœ… APIå¯†é’¥æ ¼å¼æ­£ç¡®</div>';
                        status += '<div class="status info">ğŸ”‘ APIå¯†é’¥: ' + key.substring(0, 10) + '...' + key.substring(key.length - 4) + '</div>';
                    } else {
                        status += '<div class="status warning">âš ï¸ APIå¯†é’¥æ ¼å¼å¯èƒ½ä¸æ­£ç¡®</div>';
                    }
                } else {
                    status += '<div class="status error">âŒ APIå¯†é’¥æœªé…ç½®</div>';
                }
            } else {
                status += '<div class="status error">âŒ é…ç½®æ–‡ä»¶æœªåŠ è½½</div>';
                details += 'window.CONFIG æœªå®šä¹‰\n';
            }
            
            // æ£€æŸ¥localStorage
            const storedKey = localStorage.getItem('deepseek_api_key');
            if (storedKey) {
                status += '<div class="status info">ğŸ’¾ localStorageä¸­æœ‰APIå¯†é’¥</div>';
                details += 'localStorage APIå¯†é’¥: ' + storedKey.substring(0, 10) + '...' + storedKey.substring(storedKey.length - 4) + '\n';
            } else {
                status += '<div class="status info">ğŸ’¾ localStorageä¸­æ— APIå¯†é’¥</div>';
            }
            
            statusDiv.innerHTML = status;
            detailsDiv.textContent = details;
        }

        // APIå¯†é’¥çŠ¶æ€æ£€æŸ¥
        function checkApiStatus() {
            const statusDiv = document.getElementById('api-status');
            
            let status = '';
            
            if (window.CONFIG && window.CONFIG.deepseek) {
                const config = window.CONFIG.deepseek;
                
                if (config.usePreconfiguredKey) {
                    status += '<div class="status success">âœ… ä½¿ç”¨é¢„é…ç½®çš„APIå¯†é’¥</div>';
                } else {
                    status += '<div class="status warning">âš ï¸ æœªä½¿ç”¨é¢„é…ç½®çš„APIå¯†é’¥</div>';
                }
                
                if (config.showPromptOnLoad) {
                    status += '<div class="status warning">âš ï¸ é¡µé¢åŠ è½½æ—¶ä¼šæ˜¾ç¤ºAPIå¯†é’¥æç¤º</div>';
                } else {
                    status += '<div class="status success">âœ… é¡µé¢åŠ è½½æ—¶ä¸ä¼šæ˜¾ç¤ºAPIå¯†é’¥æç¤º</div>';
                }
            }
            
            statusDiv.innerHTML = status;
        }

        // æµ‹è¯•APIå¯†é’¥
        async function testApiKey() {
            const resultDiv = document.getElementById('api-status');
            
            if (!window.CONFIG || !window.CONFIG.deepseek || !window.CONFIG.deepseek.apiKey) {
                resultDiv.innerHTML += '<div class="status error">âŒ æ— æ³•æµ‹è¯•ï¼šAPIå¯†é’¥æœªé…ç½®</div>';
                return;
            }
            
            const apiKey = window.CONFIG.deepseek.apiKey;
            resultDiv.innerHTML += '<div class="status info">ğŸ§ª æ­£åœ¨æµ‹è¯•APIå¯†é’¥...</div>';
            
            try {
                const response = await fetch('https://api.deepseek.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'deepseek-chat',
                        messages: [{
                            role: 'user',
                            content: 'ä½ å¥½ï¼Œè¯·å›å¤"æµ‹è¯•æˆåŠŸ"'
                        }],
                        max_tokens: 10
                    })
                });
                
                if (response.ok) {
                    resultDiv.innerHTML += '<div class="status success">âœ… APIå¯†é’¥æµ‹è¯•æˆåŠŸ</div>';
                } else {
                    resultDiv.innerHTML += '<div class="status error">âŒ APIå¯†é’¥æµ‹è¯•å¤±è´¥: ' + response.status + '</div>';
                }
            } catch (error) {
                resultDiv.innerHTML += '<div class="status error">âŒ APIå¯†é’¥æµ‹è¯•å‡ºé”™: ' + error.message + '</div>';
            }
        }

        // æµ‹è¯•èŠå¤©ç®¡ç†å™¨
        function testChatManager() {
            const resultDiv = document.getElementById('chat-test-result');
            
            try {
                // æ¨¡æ‹Ÿåˆ›å»ºèŠå¤©ç®¡ç†å™¨
                if (window.CONFIG && window.CONFIG.deepseek) {
                    resultDiv.innerHTML = '<div class="status success">âœ… é…ç½®å·²å°±ç»ªï¼Œå¯ä»¥åˆ›å»ºèŠå¤©ç®¡ç†å™¨</div>';
                } else {
                    resultDiv.innerHTML = '<div class="status error">âŒ é…ç½®æœªå°±ç»ªï¼Œæ— æ³•åˆ›å»ºèŠå¤©ç®¡ç†å™¨</div>';
                }
            } catch (error) {
                resultDiv.innerHTML = '<div class="status error">âŒ æµ‹è¯•å‡ºé”™: ' + error.message + '</div>';
            }
        }

        // æ¸…é™¤ç¼“å­˜
        function clearCache() {
            localStorage.clear();
            sessionStorage.clear();
            location.reload();
        }

        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨æ£€æŸ¥
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                checkConfig();
                checkApiStatus();
            }, 100);
        });
    </script>
</body>
</html>
